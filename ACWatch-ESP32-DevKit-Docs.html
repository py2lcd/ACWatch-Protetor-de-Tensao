<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACWatch - Documentação Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo para garantir uma boa aparência na impressão */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none;
            }
            .code-block {
                page-break-inside: avoid;
            }
        }
        .code-block {
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4a5568;
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .copy-button:hover {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
            
            <!-- Cabeçalho -->
            <div class="text-center border-b border-gray-200 dark:border-gray-700 pb-6 mb-6">
                <h1 class="text-4xl font-bold text-indigo-600 dark:text-indigo-400">ACWatch</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">Documentação Completa do Projeto</p>
            </div>

            <!-- Lista de Componentes -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4">Lista de Componentes</h2>
                <ul class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
                    <li><b>Placa Controladora:</b> ESP32 (NodeMCU-32S ou similar)</li>
                    <li><b>Display:</b> Módulo OLED 0.96" I2C SSD1306</li>
                    <li><b>Relógio de Tempo Real:</b> Módulo RTC DS3231</li>
                    <li><b>Sensor de Tensão:</b> Módulo ZMPT101B</li>
                    <li><b>Atuador:</b> Módulo Relé 2 Canais 5V</li>
                    <li><b>Botões:</b> 2x Push Button (Botão de Pulso)</li>
                </ul>
            </div>

            <!-- Diagrama de Conexões -->
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-6">Diagrama de Conexões</h2>
                <div class="space-y-6">
                    <div class="border border-gray-200 dark:border-gray-700 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Display OLED e Relógio RTC (Comunicação I2C)</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Estes dois componentes compartilham as mesmas vias de dados (SCL e SDA), pois usam o mesmo protocolo de comunicação.</p>
                        <table class="w-full text-left">
                            <thead><tr class="border-b dark:border-gray-600"><th class="py-2">Pino do Componente</th><th class="py-2">Pino no ESP32</th><th class="py-2">Observação</th></tr></thead>
                            <tbody>
                                <tr class="border-b dark:border-gray-700"><td class="py-2 font-mono">VCC</td><td class="py-2 font-mono text-red-500">3.3V</td><td class="py-2">Alimentação</td></tr>
                                <tr><td class="py-2 font-mono">GND</td><td class="py-2 font-mono text-blue-400">GND</td><td class="py-2">Terra</td></tr>
                                <tr><td class="py-2 font-mono">SCL</td><td class="py-2 font-mono text-yellow-400">GPIO 22</td><td class="py-2">Clock do barramento I2C</td></tr>
                                <tr><td class="py-2 font-mono">SDA</td><td class="py-2 font-mono text-green-400">GPIO 21</td><td class="py-2">Dados do barramento I2C</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="border border-gray-200 dark:border-gray-700 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Sensor de Tensão (ZMPT101B)</h3>
                        <table class="w-full text-left">
                            <thead><tr class="border-b dark:border-gray-600"><th class="py-2">Pino do Componente</th><th class="py-2">Pino no ESP32</th><th class="py-2">Observação</th></tr></thead>
                            <tbody>
                                <tr class="border-b dark:border-gray-700"><td class="py-2 font-mono">VCC</td><td class="py-2 font-mono text-red-500">3.3V</td><td class="py-2">Alimentação</td></tr>
                                <tr class="border-b dark:border-gray-700"><td class="py-2 font-mono">GND</td><td class="py-2 font-mono text-blue-400">GND</td><td class="py-2">Terra</td></tr>
                                <tr><td class="py-2 font-mono">OUT / S</td><td class="py-2 font-mono text-purple-400">GPIO 34</td><td class="py-2">Sinal analógico da tensão</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="border border-gray-200 dark:border-gray-700 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Módulo Relé (2 Canais)</h3>
                        <table class="w-full text-left">
                             <thead><tr class="border-b dark:border-gray-600"><th class="py-2">Pino do Componente</th><th class="py-2">Pino no ESP32</th><th class="py-2">Observação</th></tr></thead>
                            <tbody>
                                <tr class="border-b dark:border-gray-700"><td class="py-2 font-mono">VCC</td><td class="py-2 font-mono text-red-500">3.3V</td><td class="py-2">Alimentação da lógica</td></tr>
                                <tr class="border-b dark:border-gray-700"><td class="py-2 font-mono">GND</td><td class="py-2 font-mono text-blue-400">GND</td><td class="py-2">Terra</td></tr>
                                <tr class="border-b dark:border-gray-700"><td class="py-2 font-mono">IN1</td><td class="py-2 font-mono text-orange-400">GPIO 26</td><td class="py-2">Controle do Relé 1</td></tr>
                                <tr><td class="py-2 font-mono">IN2</td><td class="py-2 font-mono text-orange-400">GPIO 27</td><td class="py-2">Controle do Relé 2</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="border border-gray-200 dark:border-gray-700 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Botões (Push Buttons)</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Os botões são ligados entre o pino de sinal e o GND, pois o código ativa o resistor de pull-up interno do ESP32.</p>
                        <table class="w-full text-left">
                             <thead><tr class="border-b dark:border-gray-600"><th class="py-2">Função do Botão</th><th class="py-2">Pino no ESP32</th><th class="py-2">Outro terminal</th></tr></thead>
                            <tbody>
                                <tr class="border-b dark:border-gray-700"><td class="py-2">Alternar Modo (110V/220V)</td><td class="py-2 font-mono text-pink-400">GPIO 25</td><td class="py-2 font-mono text-blue-400">GND</td></tr>
                                <tr><td class="py-2">Resetar Wi-Fi</td><td class="py-2 font-mono text-pink-400">GPIO 15</td><td class="py-2 font-mono text-blue-400">GND</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Código-Fonte Completo -->
            <div>
                <h2 class="text-2xl font-semibold mb-6">Código-Fonte Completo (Sketch Arduino)</h2>
                <div class="code-block bg-gray-900 text-white rounded-lg p-4 overflow-x-auto">
                    <button class="copy-button no-print" onclick="copyCode()">Copiar Código</button>
<pre><code id="sketch-code" class="language-cpp">
/*
  ACWatch - Sketch com Web UI, RTC DS3231 e histórico de falhas
  Modificado por Gemini em 10/07/2024
  - CORREÇÃO DE UI: Impede que a atualização automática da página sobrescreva a digitação nos campos de parâmetros.
  - NOVO: Implementado ajuste de parâmetros de tensão (mín/máx) via página web.
  - NOVO: Parâmetros de tensão são salvos na memória permanente do ESP32.
  - CORREÇÃO DE LÓGICA: Garantido que o relé só ligue após 10 segundos de tensão estável na inicialização.
*/

// =================================================================
// === BIBLIOTECAS: As "caixas de ferramentas" do projeto ========
// =================================================================
#include &lt;Wire.h&gt;
#include &lt;Adafruit_GFX.h&gt;
#include &lt;Adafruit_SSD1306.h&gt;
#include &lt;WiFi.h&gt;
#include &lt;WebServer.h&gt;
#include &lt;WiFiScan.h&gt;
#include &lt;ESPmDNS.h&gt;
#include &lt;Preferences.h&gt;
#include &lt;RTClib.h&gt;
#include &lt;SPIFFS.h&gt;

// =================================================================
// === DEFINIÇÕES DO DISPLAY: Configurações da telinha OLED ========
// =================================================================
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET    -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &amp;Wire, OLED_RESET);
RTC_DS3231 rtc;

// =================================================================
// === CONFIGURAÇÕES DE REDE: Dados do Wi-Fi =======================
// =================================================================
const char* ssidAP = "ACWatch_AP";
const char* passwordAP = "12345678";
WebServer server(80);
Preferences preferences;

// =================================================================
// === PINOS: Mapeamento das conexões físicas ======================
// =================================================================
const int pinSensor   = 34;
const int pinRele1    = 26;
const int pinRele2    = 27;
const int pinBotaoModo  = 25;
const int pinResetWiFi  = 15;

// =================================================================
// === VARIÁVEIS DE ESTADO: A "memória" do programa ===============
// =================================================================
bool modo220V = false;
bool estadoRele = false;
unsigned long tempoPressionado = 0;
unsigned long ultimoAtualizacao = 0;
unsigned long tempoUltimaTensaoSegura = 0;

// =================================================================
// === PARÂMETROS DE TENSÃO: Limites de operação ===================
// =================================================================
// Valores padrão que podem ser sobrescritos pelos ajustes na página web.
float limiteMin127 = 95.0;
float limiteMax127 = 135.0;
float limiteMin220 = 200.0;
float limiteMax220 = 265.0;

// Fatores de calibração (ainda fixos no código)
const float fatorCalibracao127 = 492.7;
const float fatorCalibracao220 = 546.9;


// =================================================================
// === DECLARAÇÃO DE FUNÇÕES: Uma "lista de tarefas" para o compilador ===
// =================================================================
void setup();
void loop();
void configurarWiFi();
void handleMainPage();
void handleGetStatus();
void handleSetTime();
void handleSetParams();
void handleAlternarModo();
void handleScanWiFi();
void handleConfigurarWiFi();
void handleFalhas();
void handleLimparFalhas();
float lerTensaoRMS();
void desligarRele();
void ligarRele();
void printCentralizado(String texto, int y, int tamanho);
void atualizarDisplay(float tensao, DateTime now);
void registrarFalha(float tensao);
String formatDigit(int digit);


// =================================================================
// === PÁGINA WEB PRINCIPAL (HTML, CSS, JAVASCRIPT) ================
// =================================================================
const char PAGE_MAIN[] PROGMEM = R"=====(
&lt;!DOCTYPE html&gt;
&lt;html lang="pt-BR"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;Painel ACWatch&lt;/title&gt;
    &lt;style&gt;
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
            background-color: #111827;
            color: #f9fafb;
        }
        .card {
            background-color: #1f2937;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        h1 { font-size: 28px; font-weight: 700; margin: 0 0 8px 0; }
        .card &gt; p { color: #9ca3af; margin: 0 0 24px 0; }
        .display-box { background-color: #374151; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .display-box .label { font-size: 12px; font-weight: 500; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; }
        .voltage-display { background-color: #374151; border-radius: 8px; padding: 20px; margin-bottom: 10px; }
        #currentVoltage { font-size: 48px; font-weight: 700; }
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 24px; }
        .status-item { background-color: #374151; border-radius: 8px; padding: 16px; }
        .status-value { font-size: 24px; font-weight: 700; }
        .relay-on { color: #4ade80; }
        .relay-off { color: #f87171; }
        #currentTime { font-size: 40px; font-weight: 700; margin: 4px 0; letter-spacing: 2px; }
        #currentDate { font-size: 18px; color: #9ca3af; }
        form { display: flex; flex-direction: column; gap: 16px; }
        label { display: block; text-align: left; font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        input[type="number"], select {
            width: 100%; padding: 10px; border: 1px solid #4b5563; border-radius: 8px; box-sizing: border-box;
            font-size: 16px; background-color: #374151; color: #f9fafb;
        }
        select {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239ca3af%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.65em auto;
        }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .form-grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        button, .button-link {
            width: 100%; padding: 12px; border: none; border-radius: 8px; background-color: #4f46e5; color: white;
            font-size: 16px; font-weight: 500; cursor: pointer; transition: background-color 0.2s;
            text-decoration: none; display: inline-block; box-sizing: border-box;
        }
        button:hover, .button-link:hover { background-color: #4338ca; }
        #statusMessage { height: 24px; font-size: 16px; font-weight: 500; margin-top: 16px;}
        .status-success { color: #4ade80; }
        .status-error { color: #f87171; }
        .links { padding-top: 16px; margin-top: 24px; border-top: 1px solid #374151; }
        .links p { font-weight: 600; margin: 0 0 8px 0; }
        .links-container { display: flex; flex-direction: column; gap: 10px; }
        details &gt; summary { cursor: pointer; color: #9ca3af; margin-top: 16px; padding: 8px; border-radius: 8px; }
        details &gt; summary:hover { background-color: #374151; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div class="card"&gt;
        &lt;h1&gt;ACWatch&lt;/h1&gt;
        &lt;p&gt;Painel de controle do dispositivo.&lt;/p&gt;
        
        &lt;div class="voltage-display"&gt;
            &lt;div class="label"&gt;Tens&amp;atilde;o&lt;/div&gt;
            &lt;div id="currentVoltage" class="status-value"&gt;-- V&lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="status-grid"&gt;
            &lt;div class="status-item"&gt;
                &lt;div class="label"&gt;Modo&lt;/div&gt;
                &lt;div id="currentMode" class="status-value"&gt;--&lt;/div&gt;
            &lt;/div&gt;
            &lt;div class="status-item"&gt;
                &lt;div class="label"&gt;Rel&amp;eacute;&lt;/div&gt;
                &lt;div id="relayStatus" class="status-value"&gt;--&lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="display-box"&gt;
            &lt;p class="label"&gt;HORA ATUAL DO DISPOSITIVO&lt;/p&gt;
            &lt;p id="currentTime"&gt;--:--:--&lt;/p&gt;
            &lt;p id="currentDate"&gt;--/--/----&lt;/p&gt;
        &lt;/div&gt;

        &lt;div id="statusMessage"&gt;&lt;/div&gt;

        &lt;div class="links"&gt;
            &lt;p&gt;Configura&amp;ccedil;&amp;otilde;es:&lt;/p&gt;
            &lt;div class="links-container"&gt;
                &lt;form action="/modo" method="POST" style="margin:0;"&gt;&lt;button type="submit"&gt;Alternar Modo 110V/220V&lt;/button&gt;&lt;/form&gt;
                &lt;a href="/scan" class="button-link"&gt;Configurar Wi-Fi&lt;/a&gt;
                &lt;a href="/falhas" class="button-link"&gt;Ver Falhas&lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;details&gt;
            &lt;summary&gt;Ajustar Data e Hora&lt;/summary&gt;
            &lt;form id="timeForm" style="margin-top: 16px;"&gt;
                &lt;div class="form-grid"&gt;
                    &lt;div&gt;&lt;label for="day"&gt;Dia&lt;/label&gt;&lt;select id="day" name="day"&gt;&lt;/select&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="month"&gt;M&amp;ecirc;s&lt;/label&gt;&lt;select id="month" name="month"&gt;&lt;/select&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="year"&gt;Ano&lt;/label&gt;&lt;select id="year" name="year"&gt;&lt;/select&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="hour"&gt;Hora&lt;/label&gt;&lt;select id="hour" name="hour"&gt;&lt;/select&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="minute"&gt;Minuto&lt;/label&gt;&lt;select id="minute" name="minute"&gt;&lt;/select&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="second"&gt;Segundo&lt;/label&gt;&lt;select id="second" name="second"&gt;&lt;/select&gt;&lt;/div&gt;
                &lt;/div&gt;
                &lt;button type="submit"&gt;Confirmar Ajuste de Hora&lt;/button&gt;
            &lt;/form&gt;
        &lt;/details&gt;
        
        &lt;details&gt;
            &lt;summary&gt;Ajustar Par&amp;acirc;metros de Tens&amp;atilde;o&lt;/summary&gt;
            &lt;form id="paramsForm" style="margin-top: 16px;"&gt;
                &lt;div class="form-grid-2"&gt;
                    &lt;div&gt;&lt;label for="min110"&gt;M&amp;iacute;n. 110V&lt;/label&gt;&lt;input type="number" id="min110" name="min110" step="0.1"&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="max110"&gt;M&amp;aacute;x. 110V&lt;/label&gt;&lt;input type="number" id="max110" name="max110" step="0.1"&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="min220"&gt;M&amp;iacute;n. 220V&lt;/label&gt;&lt;input type="number" id="min220" name="min220" step="0.1"&gt;&lt;/div&gt;
                    &lt;div&gt;&lt;label for="max220"&gt;M&amp;aacute;x. 220V&lt;/label&gt;&lt;input type="number" id="max220" name="max220" step="0.1"&gt;&lt;/div&gt;
                &lt;/div&gt;
                &lt;button type="submit"&gt;Salvar Par&amp;acirc;metros&lt;/button&gt;
            &lt;/form&gt;
        &lt;/details&gt;
    &lt;/div&gt;
&lt;script&gt;
    const timeForm = document.getElementById('timeForm');
    const paramsForm = document.getElementById('paramsForm');
    const statusMessage = document.getElementById('statusMessage');
    let initialParamsLoad = true;

    function populateDateTimeSelectors() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const daySel = document.getElementById('day');
        const monthSel = document.getElementById('month');
        const yearSel = document.getElementById('year');
        const hourSel = document.getElementById('hour');
        const minuteSel = document.getElementById('minute');
        const secondSel = document.getElementById('second');
        const pad = (n) =&gt; n.toString().padStart(2, '0');
        for (let i = 1; i &lt;= 31; i++) daySel.options.add(new Option(pad(i), i));
        for (let i = 1; i &lt;= 12; i++) monthSel.options.add(new Option(pad(i), i));
        for (let i = currentYear - 5; i &lt;= currentYear + 5; i++) yearSel.options.add(new Option(i, i));
        for (let i = 0; i &lt;= 23; i++) hourSel.options.add(new Option(pad(i), i));
        for (let i = 0; i &lt;= 59; i++) minuteSel.options.add(new Option(pad(i), i));
        for (let i = 0; i &lt;= 59; i++) secondSel.options.add(new Option(pad(i), i));
        daySel.value = now.getDate();
        monthSel.value = now.getMonth() + 1;
        yearSel.value = currentYear;
        hourSel.value = now.getHours();
        minuteSel.value = now.getMinutes();
        secondSel.value = now.getSeconds();
    }

    async function fetchStatus() {
        try {
            const response = await fetch(window.location.origin + '/get-status');
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            document.getElementById('currentTime').textContent = data.time;
            document.getElementById('currentDate').textContent = data.date;
            document.getElementById('currentVoltage').textContent = data.voltage + ' V';
            document.getElementById('currentMode').textContent = data.mode;
            
            const relayStatusEl = document.getElementById('relayStatus');
            relayStatusEl.textContent = data.relay;
            relayStatusEl.className = 'status-value ' + (data.relay === 'LIGADO' ? 'relay-on' : 'relay-off');

            if (initialParamsLoad) {
                document.getElementById('min110').value = data.limMin110;
                document.getElementById('max110').value = data.limMax110;
                document.getElementById('min220').value = data.limMin220;
                document.getElementById('max220').value = data.limMax220;
                initialParamsLoad = false;
            }

        } catch (error) {
            console.error('Erro ao buscar status:', error);
        }
    }
    async function handleTimeSubmit(event) {
        event.preventDefault();
        const day = document.getElementById('day').value;
        const month = document.getElementById('month').value;
        const year = document.getElementById('year').value;
        const hour = document.getElementById('hour').value;
        const minute = document.getElementById('minute').value;
        const second = document.getElementById('second').value;
        const pad = (n) =&gt; n.toString().padStart(2, '0');
        const formData = new URLSearchParams();
        formData.append('date', `${year}-${pad(month)}-${pad(day)}`);
        formData.append('time', `${pad(hour)}:${pad(minute)}:${pad(second)}`);
        try {
            const response = await fetch(window.location.origin + '/set-time', { method: 'POST', body: formData });
            const resultText = await response.text();
            showStatusMessage(resultText, response.ok);
            if(response.ok) fetchStatus();
        } catch (error) {
            showStatusMessage('Erro de conexao ao ajustar.', false);
        }
    }
    async function handleParamsSubmit(event) {
        event.preventDefault();
        const formData = new URLSearchParams(new FormData(paramsForm));
        try {
            const response = await fetch(window.location.origin + '/set-params', { method: 'POST', body: formData });
            const resultText = await response.text();
            showStatusMessage(resultText, response.ok);
            if (response.ok) {
                initialParamsLoad = true;
                fetchStatus();
            }
        } catch (error) {
            showStatusMessage('Erro de conexao ao salvar parametros.', false);
        }
    }
    function showStatusMessage(message, isSuccess) {
        statusMessage.textContent = message;
        statusMessage.className = isSuccess ? 'status-success' : 'status-error';
        setTimeout(() =&gt; { statusMessage.textContent = ''; }, 5000);
    }
    document.addEventListener('DOMContentLoaded', () =&gt; {
        populateDateTimeSelectors();
        fetchStatus();
        setInterval(fetchStatus, 1000);
        timeForm.addEventListener('submit', handleTimeSubmit);
        paramsForm.addEventListener('submit', handleParamsSubmit);
    });
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
)=====";


// =================================================================
// === FUNÇÃO SETUP: O que acontece quando o ESP32 liga ==========
// =================================================================
void setup() {
  // Inicia a comunicação com o computador para debug
  Serial.begin(115200);

  // Configura os pinos como SAÍDA ou ENTRADA
  pinMode(pinRele1, OUTPUT);
  pinMode(pinRele2, OUTPUT);
  pinMode(pinBotaoModo, INPUT_PULLUP);
  pinMode(pinResetWiFi, INPUT_PULLUP);
  
  desligarRele(); 
  tempoUltimaTensaoSegura = millis(); 

  // Inicia o display OLED
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println("Display nao encontrado");
    while (true); // Trava o código se não encontrar o display
  }
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("ACWatch iniciando...");
  display.display();

  // Inicia o sistema de arquivos SPIFFS
  if (!SPIFFS.begin(true)) {
    Serial.println("Falha ao montar SPIFFS");
  }

  // Inicia a memória para salvar as preferências
  preferences.begin("ACWatch", false);

  // Carrega os parâmetros de tensão salvos ou usa os padrões
  limiteMin127 = preferences.getFloat("limMin127", 95.0);
  limiteMax127 = preferences.getFloat("limMax127", 135.0);
  limiteMin220 = preferences.getFloat("limMin220", 200.0);
  limiteMax220 = preferences.getFloat("limMax220", 265.0);

  // Tenta se conectar ao Wi-Fi ou cria um Ponto de Acesso
  configurarWiFi();

  // Configura as "páginas" do servidor web
  server.on("/", HTTP_GET, handleMainPage);
  server.on("/get-status", HTTP_GET, handleGetStatus);
  server.on("/set-time", HTTP_POST, handleSetTime);
  server.on("/set-params", HTTP_POST, handleSetParams); // <-- ROTA NOVA
  server.on("/modo", HTTP_POST, handleAlternarModo);
  server.on("/scan", HTTP_GET, handleScanWiFi);
  server.on("/configurar", HTTP_POST, handleConfigurarWiFi);
  server.on("/falhas", HTTP_GET, handleFalhas);
  server.on("/limpar", HTTP_POST, handleLimparFalhas);
  
  server.begin(); // Inicia o servidor web

  // Inicia o serviço de mDNS
  if (MDNS.begin("acwatch")) {
    Serial.println("mDNS iniciado: http://acwatch.local");
  } else {
    Serial.println("Falha ao iniciar mDNS");
  }

  // Inicia o relógio RTC
  if (!rtc.begin()) {
    Serial.println("RTC nao encontrado");
    while (true);
  }
  // Se o RTC perdeu energia, ajusta a hora com a data da compilação
  if (rtc.lostPower()) {
    Serial.println("RTC perdeu a hora, configurando padrao");
    rtc.adjust(DateTime(F(__DATE__), F(__TIME__)));
  }
}

// =================================================================
// === FUNÇÃO LOOP: O que fica repetindo sem parar ===============
// =================================================================
void loop() {
  // Permite que o servidor web atenda aos clientes
  server.handleClient();

  // Verifica se o botão de MODO foi pressionado
  static unsigned long ultimoClique = 0;
  if (digitalRead(pinBotaoModo) == LOW &amp;&amp; millis() - ultimoClique &gt; 1000) {
    modo220V = !modo220V;
    ultimoClique = millis();
    Serial.println(modo220V ? "Modo 220V" : "Modo 110V");
  }

  // Verifica se o botão de RESET WI-FI foi pressionado por 5 segundos
  if (digitalRead(pinResetWiFi) == LOW) {
    if (tempoPressionado == 0) tempoPressionado = millis();
    if (millis() - tempoPressionado &gt; 5000) {
      Serial.println("Reset Wi-Fi solicitado!");
      preferences.clear(); // Apaga as credenciais salvas
      delay(1000);
      ESP.restart(); // Reinicia o ESP32
    }
  } else {
    tempoPressionado = 0;
  }

  // Atualiza as informações no display a cada meio segundo
  if (millis() - ultimoAtualizacao &gt; 500) {
    atualizarDisplay(lerTensaoRMS(), rtc.now());
    ultimoAtualizacao = millis();
  }

  // A lógica de proteção agora usa as variáveis que podem ser ajustadas
  float tensao = lerTensaoRMS();
  float limiteMin = modo220V ? limiteMin220 : limiteMin127;
  float limiteMax = modo220V ? limiteMax220 : limiteMax127;

  // Se a tensão estiver FORA dos limites de segurança
  if (tensao &lt; limiteMin || tensao &gt; limiteMax) {
    if (estadoRele) { // E o relé estiver ligado
      desligarRele(); // Desliga o relé imediatamente
      Serial.println("Tensao fora da faixa! Rele desligado.");
      registrarFalha(tensao); // Salva o erro no log
    }
    // Atualiza o marcador de tempo para o último evento inseguro, reiniciando o contador de 10s
    tempoUltimaTensaoSegura = millis();
  }
  // Se a tensão estiver DENTRO dos limites de segurança
  else {
    // E se o relé estiver desligado E já se passaram 10 segundos de estabilidade contínua
    if (!estadoRele &amp;&amp; (millis() - tempoUltimaTensaoSegura &gt; 10000)) {
      ligarRele(); // Liga o relé novamente
      Serial.println("Tensao estavel por 10s. Rele religado.");
    }
  }
}

// =================================================================
// === FUNÇÕES DO SERVIDOR WEB: O que cada endereço faz ==========
// =================================================================

// Envia a página web principal para o navegador
void handleMainPage() {
  server.send(200, "text/html", PAGE_MAIN);
}

// Envia os dados de status (tensão, modo, etc.) em formato JSON para a página web
void handleGetStatus() {
  DateTime now = rtc.now();
  
  String dateStr = String(formatDigit(now.day())) + "/" + String(formatDigit(now.month())) + "/" + String(now.year());
  String timeStr = String(formatDigit(now.hour())) + ":" + String(formatDigit(now.minute())) + ":" + String(formatDigit(now.second()));
  String voltageStr = String(lerTensaoRMS(), 1);
  String modeStr = modo220V ? "220V" : "110V";
  String relayStr = estadoRele ? "LIGADO" : "DESLIGADO";

  String json = "{";
  json += "\"date\":\"" + dateStr + "\",";
  json += "\"time\":\"" + timeStr + "\",";
  json += "\"voltage\":" + voltageStr + ",";
  json += "\"mode\":\"" + modeStr + "\",";
  json += "\"relay\":\"" + relayStr + "\",";
  // Adiciona os limites atuais ao JSON para preencher o formulário na página
  json += "\"limMin110\":" + String(limiteMin127) + ",";
  json += "\"limMax110\":" + String(limiteMax127) + ",";
  json += "\"limMin220\":" + String(limiteMin220) + ",";
  json += "\"limMax220\":" + String(limiteMax220);
  json += "}";
  
  server.send(200, "application/json", json);
}

// Recebe os dados da página web e ajusta a hora do relógio
void handleSetTime() {
  if (server.hasArg("date") &amp;&amp; server.hasArg("time")) {
    String dateStr = server.arg("date");
    String timeStr = server.arg("time");
    int year, month, day, hour, minute, second;
    sscanf(dateStr.c_str(), "%d-%d-%d", &amp;year, &amp;month, &amp;day);
    sscanf(timeStr.c_str(), "%d:%d:%d", &amp;hour, &amp;minute, &amp;second);
    rtc.adjust(DateTime(year, month, day, hour, minute, second));
    server.send(200, "text/plain", "Data e Hora ajustadas com sucesso!");
  } else {
    server.send(400, "text/plain", "Erro: Dados incompletos.");
  }
}

// <-- NOVA FUNÇÃO PARA SALVAR OS PARÂMETROS DE TENSÃO -->
void handleSetParams() {
  // Verifica se todos os 4 argumentos foram recebidos
  if (server.hasArg("min110") &amp;&amp; server.hasArg("max110") &amp;&amp; server.hasArg("min220") &amp;&amp; server.hasArg("max220")) {
    // Atualiza as variáveis globais com os novos valores
    limiteMin127 = server.arg("min110").toFloat();
    limiteMax127 = server.arg("max110").toFloat();
    limiteMin220 = server.arg("min220").toFloat();
    limiteMax220 = server.arg("max220").toFloat();

    // Salva os novos valores na memória permanente
    preferences.putFloat("limMin127", limiteMin127);
    preferences.putFloat("limMax127", limiteMax127);
    preferences.putFloat("limMin220", limiteMin220);
    preferences.putFloat("limMax220", limiteMax220);
    
    Serial.println("Novos parametros de tensao salvos!");
    server.send(200, "text/plain", "Parametros salvos com sucesso!");
  } else {
    server.send(400, "text/plain", "Erro: Dados de parametros incompletos.");
  }
}

// Tenta se conectar a uma rede Wi-Fi salva; se falhar, cria seu próprio Ponto de Acesso
void configurarWiFi() {
  String ssid = preferences.getString("ssid", "");
  String password = preferences.getString("password", "");
  if (ssid != "" &amp;&amp; password != "") {
    WiFi.begin(ssid.c_str(), password.c_str());
    Serial.print("Conectando ao Wi-Fi: ");
    Serial.println(ssid);
    unsigned long inicio = millis();
    while (WiFi.status() != WL_CONNECTED &amp;&amp; millis() - inicio &lt; 10000) {
      delay(500);
      Serial.print(".");
    }
    if (WiFi.status() == WL_CONNECTED) {
      Serial.println("\nConectado ao Wi-Fi!");
      Serial.print("IP: ");
      Serial.println(WiFi.localIP());
      return;
    } else {
      Serial.println("\nFalha ao conectar ao Wi-Fi.");
    }
  }
  WiFi.softAP(ssidAP, passwordAP);
  IPAddress IP = WiFi.softAPIP();
  Serial.print("Modo AP ativado. Acesse: http://");
  Serial.println(IP);
}

// Alterna o modo de operação entre 110V e 220V
void handleAlternarModo() {
  modo220V = !modo220V;
  tempoUltimaTensaoSegura = millis();
  server.sendHeader("Location", "/");
  server.send(303);
}

// Procura redes Wi-Fi e exibe uma página para o usuário se conectar
void handleScanWiFi() {
  int n = WiFi.scanNetworks();
  String html = R"=====(
   &lt;!DOCTYPE html&gt;&lt;html lang="pt-BR"&gt;&lt;head&gt;
   &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;&lt;title&gt;Scan Wi-Fi&lt;/title&gt;
   &lt;style&gt;
        body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;margin: 0;padding: 20px;display: flex;justify-content: center;align-items: center;min-height: 100vh;box-sizing: border-box;background-color: #111827;color: #f9fafb;}
        .card {background-color: #1f2937;border-radius: 16px;padding: 32px;width: 100%;max-width: 400px;box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);text-align: center;}
        h1 {font-size: 28px;font-weight: 700;margin: 0 0 24px 0;}
        .wifi-item {padding: 12px; border-bottom: 1px solid #4b5563; cursor: pointer; text-align: left;}
        .wifi-item:hover {background-color: #374151;}
        form { display: flex; flex-direction: column; gap: 16px; margin-top: 24px;}
        input {width: 100%;padding: 10px;border: 1px solid #4b5563;border-radius: 8px;box-sizing: border-box;font-size: 16px;background-color: #374151;color: #f9fafb;}
        button, .button-link {width: 100%;padding: 12px;border: none;border-radius: 8px;background-color: #4f46e5;color: white;font-size: 16px;font-weight: 500;cursor: pointer;transition: background-color 0.2s;text-decoration: none;display: inline-block;box-sizing: border-box; margin-top: 8px;}
        button:hover, .button-link:hover { background-color: #4338ca; }
   &lt;/style&gt;
   &lt;/head&gt;&lt;body&gt;
   &lt;div class="card"&gt;
     &lt;h1&gt;Redes Wi-Fi Dispon&amp;iacute;veis&lt;/h1&gt;
     &lt;div style="max-height: 200px; overflow-y: auto; border: 1px solid #4b5563; border-radius: 8px;"&gt;
  )=====";

  if (n &gt; 0) {
    for (int i = 0; i &lt; n; i++) {
      html += "&lt;div class='wifi-item' onclick=\"document.getElementById('ssid').value='" + WiFi.SSID(i) + "'\"&gt;" + WiFi.SSID(i) + " (" + WiFi.RSSI(i) + "dBm)&lt;/div&gt;";
    }
  } else {
    html += "&lt;p style='padding: 12px;'&gt;Nenhuma rede encontrada.&lt;/p&gt;";
  }

  html += R"=====(
     &lt;/div&gt;
     &lt;form action="/configurar" method="POST"&gt;
       &lt;input type="text" id="ssid" name="ssid" placeholder="Nome da Rede (SSID)"&gt;
       &lt;input type="password" id="password" name="password" placeholder="Senha"&gt;
       &lt;button type="submit"&gt;Salvar e Reiniciar&lt;/button&gt;
     &lt;/form&gt;
     &lt;a href="/" class="button-link"&gt;Voltar&lt;/a&gt;
   &lt;/div&gt;
   &lt;/body&gt;&lt;/html&gt;
  )=====";

  server.send(200, "text/html", html);
}

// Salva as credenciais de Wi-Fi na memória e reinicia o ESP32
void handleConfigurarWiFi() {
  if (server.hasArg("ssid") &amp;&amp; server.hasArg("password")) {
    String ssid = server.arg("ssid");
    String password = server.arg("password");
    preferences.putString("ssid", ssid);
    preferences.putString("password", password);
    server.send(200, "text/plain", "Credenciais salvas! Reiniciando...");
    delay(1000);
    ESP.restart();
  } else {
    server.send(400, "text/plain", "Falha ao salvar credenciais.");
  }
}

// Mostra a página com o histórico de falhas de tensão
void handleFalhas() {
  File log = SPIFFS.open("/falhas.log", FILE_READ);
  String html = R"=====(
  &lt;!DOCTYPE html&gt;&lt;html lang="pt-BR"&gt;&lt;head&gt;&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;&lt;title&gt;Hist&amp;oacute;rico de Falhas&lt;/title&gt;
  &lt;style&gt;
        body {font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;margin: 0;padding: 20px;display: flex;justify-content: center;align-items: center;min-height: 100vh;box-sizing: border-box;background-color: #111827;color: #f9fafb;}
        .card {background-color: #1f2937;border-radius: 16px;padding: 32px;width: 100%;max-width: 600px;box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);text-align: center;}
        h1 {font-size: 28px;font-weight: 700;margin: 0 0 24px 0;}
        table {width: 100%; border-collapse: collapse; }
        th, td {border: 1px solid #4b5563; padding: 12px; text-align: left;}
        th {background-color: #374151;}
        button, .button-link {width: 100%;padding: 12px;border: none;border-radius: 8px;background-color: #4f46e5;color: white;font-size: 16px;font-weight: 500;cursor: pointer;transition: background-color 0.2s;text-decoration: none;display: inline-block;box-sizing: border-box; margin-top: 16px;}
        button:hover, .button-link:hover { background-color: #4338ca; }
        .button-danger { background-color: #dc2626; }
        .button-danger:hover { background-color: #b91c1c; }
  &lt;/style&gt;
  &lt;/head&gt;&lt;body&gt;
  &lt;div class="card"&gt;
    &lt;h1&gt;Hist&amp;oacute;rico de Falhas&lt;/h1&gt;
    &lt;div style="max-height: 400px; overflow-y: auto;"&gt;
    &lt;table&gt;
  )=====";

  if (!log || log.size() == 0) {
    html += "&lt;tr&gt;&lt;td colspan='2' style='text-align: center;'&gt;Nenhuma falha registrada.&lt;/td&gt;&lt;/tr&gt;";
  } else {
    html += "&lt;tr&gt;&lt;th&gt;Data e Hora&lt;/th&gt;&lt;th&gt;Evento&lt;/th&gt;&lt;/tr&gt;";
    while (log.available()) {
      String linha = log.readStringUntil('\n');
      html += "&lt;tr&gt;&lt;td colspan='2'&gt;" + linha + "&lt;/td&gt;&lt;/tr&gt;";
    }
  }
  log.close();
  
  html += R"=====(
    &lt;/table&gt;
    &lt;/div&gt;
    &lt;form action="/limpar" method="POST" onsubmit="return confirm('Tem certeza que deseja apagar todo o historico?');"&gt;
      &lt;button type="submit" class="button-danger"&gt;Limpar Hist&amp;oacute;rico&lt;/button&gt;
    &lt;/form&gt;
    &lt;a href="/" class="button-link"&gt;Voltar&lt;/a&gt;
  &lt;/div&gt;
  &lt;/body&gt;&lt;/html&gt;
  )=====";
  server.send(200, "text/html", html);
}

// Apaga o arquivo de log de falhas
void handleLimparFalhas() {
  if (SPIFFS.exists("/falhas.log")) {
    SPIFFS.remove("/falhas.log");
    server.sendHeader("Location", "/falhas");
    server.send(303);
  } else {
    server.send(200, "text/plain", "Nenhum historico para apagar.");
  }
}


// =================================================================
// === FUNÇÕES AUXILIARES: Tarefas de apoio ========================
// =================================================================

// Adiciona um zero à esquerda para números menores que 10 (ex: 7 vira "07")
String formatDigit(int digit) {
  if (digit &lt; 10) {
    return "0" + String(digit);
  }
  return String(digit);
}

// Lê o valor do sensor e calcula a tensão RMS real
float lerTensaoRMS() {
  const int N = 1000;
  float soma = 0;
  for (int i = 0; i &lt; N; i++) {
    int leitura = analogRead(pinSensor);
    float tensao = (leitura - 2048) * (3.3 / 4096.0);
    soma += tensao * tensao;
  }
  float vrms = sqrt(soma / N);
  float fator = modo220V ? fatorCalibracao220 : fatorCalibracao127;
  return vrms * fator;
}

// Desliga os dois relés
void desligarRele() {
  digitalWrite(pinRele1, LOW);
  digitalWrite(pinRele2, LOW);
  estadoRele = false;
}

// Liga os dois relés
void ligarRele() {
  digitalWrite(pinRele1, HIGH);
  digitalWrite(pinRele2, HIGH);
  estadoRele = true;
}

// Função para ajudar a centralizar texto no display OLED
void printCentralizado(String texto, int y, int tamanho) {
  int16_t x1, y1;
  uint16_t largura, altura;
  display.setTextSize(tamanho);
  display.getTextBounds(texto, 0, y, &amp;x1, &amp;y1, &amp;largura, &amp;altura);
  int x = (SCREEN_WIDTH - largura) / 2;
  display.setCursor(x, y);
  display.print(texto);
}

// Desenha todas as informações no display OLED
void atualizarDisplay(float tensao, DateTime now) {
  bool alertaTensao = false;
  float limiteMin = modo220V ? limiteMin220 : limiteMin127;
  float limiteMax = modo220V ? limiteMax220 : limiteMax127;
  if (tensao &lt; limiteMin || tensao &gt; limiteMax) {
    alertaTensao = true;
  }

  // Faz o display piscar se a tensão estiver fora da faixa
  if (alertaTensao &amp;&amp; (millis() % 1000 &lt; 500)) {
    display.invertDisplay(true);
  } else {
    display.invertDisplay(false);
  }

  display.clearDisplay();

  printCentralizado("ACWatch", 0, 2);

  String leitura = String(tensao, 1) + " V";
  printCentralizado(leitura, 18, 2);

  String status = String(modo220V ? "MODO: 220V" : "MODO: 110V") +
                  (estadoRele ? " LIGADO" : " DESLIGADO");
  printCentralizado(status, 36, 1);

  String horaBR = String(now.day()) + "/" + String(now.month()) + "/" + String(now.year()) + " " +
                  String(now.hour()) + ":" + String(now.minute()) + ":" + String(now.second());
  printCentralizado(horaBR, 48, 1);

  display.display();
}

// Salva uma nova linha no arquivo de log de falhas
void registrarFalha(float tensao) {
  DateTime now = rtc.now();
  String registro = now.timestamp() + " - Tensao fora da faixa: " + String(tensao, 1) + "V\n";

  File log = SPIFFS.open("/falhas.log", FILE_APPEND);
  if (log) {
    log.print(registro);
    log.close();
    Serial.println("Falha registrada no SPIFFS.");
  } else {
    Serial.println("Erro ao abrir falhas.log");
  }
}
